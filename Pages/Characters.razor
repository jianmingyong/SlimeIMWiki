@page "/characters"

@inject HttpClient HttpClient
@inject IMemoryCache MemoryCache
@inject IJSRuntime JsRuntime

<Alert Color="Color.Danger" Visible="true">
    <AlertDescription>
        Please be aware that some characters may contains outdated information.
    </AlertDescription>
</Alert>

<Divider DividerType="DividerType.TextContent" Text="Filters" Margin="Margin.Is4.OnY"/>

<Div>Something here</Div>

<Divider DividerType="DividerType.TextContent" Text="Characters" Margin="Margin.Is4.OnY"/>

<Div Flex="Flex.Wrap" Gap="Gap.Is3.OnX.Is5.OnY" Padding="Padding.Is5.FromTop">
    @foreach (var unit in ProtectionUnits)
    {
        <ProtectionUnit Unit="unit"
                        Forces="Forces"
                        ProtectionAttributes="ProtectionAttributes"
                        ProtectionAttackTypes="ProtectionAttackTypes"></ProtectionUnit>
    }

    @for (var i = 0; i < 0; i++)
    {
        <a href="Characters/Alice" style="position: relative; width: 100px; height: 100px">
            <Div Position="Position.Absolute.Start.Is0.Top.Is0.Translate.MiddleY"
                 Padding="Padding.Is1.OnX"
                 TextSize="TextSize.ExtraSmall"
                 TextColor="TextColor.Body"
                 Style="z-index:4; background-color: #000000BB">Alice
            </Div>
            <Image Position="Position.Absolute.Start.Is0.Top.Is0" Width="Width.Is25"
                   Source="image/rarity/badgeClassUp.png"
                   Style="z-index: 3"></Image>
            <Image Position="Position.Absolute.End.Is0.Top.Is0" Width="Width.Is25"
                   Source="image/battle/attributes/space.png"
                   Style="z-index: 3"></Image>
            <Image Position="Position.Absolute.End.Is0" Width="Width.Is25"
                   Source="image/battle/attack_types/magic.png"
                   Style="z-index: 3; top: 25%"></Image>
            <Image Position="Position.Absolute.Start.Is0.Bottom.Is0" Width="Width.Is33"
                   Source="image/rarity/starCharaL3A.png"
                   Style="z-index: 3"></Image>
            <Image Position="Position.Absolute.Start.Is0.Top.Is0" Width="Width.Is100"
                   Source="image/rarity/frameMemberM3.png"
                   Style="z-index: 2"></Image>
            <Image Position="Position.Absolute.Start.Is0.Top.Is0" Width="Width.Is100"
                   Source="image/battle/characters/AliceDefault/3/AliceDefault_3_CharaPartyM.png"
                   Style="z-index: 1"></Image>
            <Image Position="Position.Absolute.Start.Is0.Top.Is0" Width="Width.Is100"
                   Source="image/rarity/baseMemberM3.png"
                   Style="z-index: 0"></Image>
        </a>
    }
</Div>

@code
{
    private Force[] Forces { get; set; } = [];

    private Models.ProtectionUnit[] ProtectionUnits { get; set; } = [];

    private ProtectionAttackType[] ProtectionAttackTypes { get; set; } = [];

    private ProtectionAttribute[] ProtectionAttributes { get; set; } = [];

    protected override async Task OnInitializedAsync()
    {
        Forces = await MemoryCache.GetOrCreateAsync(nameof(Force), async entry =>
        {
            entry.SetAbsoluteExpiration(TimeSpan.FromHours(1));
            return await HttpClient.GetFromJsonAsync("data/forces.json", JsonSerializer.Custom.ForceArray);
        }) ?? [];

        ProtectionUnits = await MemoryCache.GetOrCreateAsync(nameof(Models.ProtectionUnit), async entry =>
        {
            entry.SetAbsoluteExpiration(TimeSpan.FromHours(1));
            return await HttpClient.GetFromJsonAsync("data/protection_units.json", JsonSerializer.Custom.ProtectionUnitArray);
        }) ?? [];

        ProtectionAttackTypes = await MemoryCache.GetOrCreateAsync(nameof(ProtectionAttackType), async entry =>
        {
            entry.SetAbsoluteExpiration(TimeSpan.FromHours(1));
            return await HttpClient.GetFromJsonAsync("data/protection_attack_types.json", JsonSerializer.Custom.ProtectionAttackTypeArray);
        }) ?? [];

        ProtectionAttributes = await MemoryCache.GetOrCreateAsync(nameof(ProtectionAttribute), async entry =>
        {
            entry.SetAbsoluteExpiration(TimeSpan.FromHours(1));
            return await HttpClient.GetFromJsonAsync("data/protection_attributes.json", JsonSerializer.Custom.ProtectionAttributeArray);
        }) ?? [];
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await JsRuntime.InvokeVoidAsync("updateUnitIcons");
    }
}
